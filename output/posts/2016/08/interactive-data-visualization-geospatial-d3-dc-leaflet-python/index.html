<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Adil Moujahid, Bridging Tech and Art">


        
<style type="text/css">
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.highlight .hll { background-color: var(--jp-cell-editor-active-background) }
.highlight { background: var(--jp-cell-editor-background); color: var(--jp-mirror-editor-variable-color) }
.highlight .c { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment */
.highlight .err { color: var(--jp-mirror-editor-error-color) } /* Error */
.highlight .k { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword */
.highlight .o { color: var(--jp-mirror-editor-operator-color); font-weight: bold } /* Operator */
.highlight .p { color: var(--jp-mirror-editor-punctuation-color) } /* Punctuation */
.highlight .ch { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Hashbang */
.highlight .cm { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Multiline */
.highlight .cp { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Preproc */
.highlight .cpf { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.PreprocFile */
.highlight .c1 { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Single */
.highlight .cs { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Special */
.highlight .kc { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Type */
.highlight .m { color: var(--jp-mirror-editor-number-color) } /* Literal.Number */
.highlight .s { color: var(--jp-mirror-editor-string-color) } /* Literal.String */
.highlight .ow { color: var(--jp-mirror-editor-operator-color); font-weight: bold } /* Operator.Word */
.highlight .pm { color: var(--jp-mirror-editor-punctuation-color) } /* Punctuation.Marker */
.highlight .w { color: var(--jp-mirror-editor-variable-color) } /* Text.Whitespace */
.highlight .mb { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Bin */
.highlight .mf { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Float */
.highlight .mh { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Hex */
.highlight .mi { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Integer */
.highlight .mo { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Oct */
.highlight .sa { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Affix */
.highlight .sb { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Backtick */
.highlight .sc { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Char */
.highlight .dl { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Delimiter */
.highlight .sd { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Doc */
.highlight .s2 { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Double */
.highlight .se { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Escape */
.highlight .sh { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Heredoc */
.highlight .si { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Interpol */
.highlight .sx { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Other */
.highlight .sr { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Regex */
.highlight .s1 { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Single */
.highlight .ss { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Symbol */
.highlight .il { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Integer.Long */
</style>

<style type="text/css">
/* Overrides of notebook CSS for static HTML export */
div.entry-content {
  overflow: visible;
  padding: 8px;
}
.input_area {
  padding: 0.2em;
}

a.heading-anchor {
 white-space: normal;
}

.rendered_html
code {
 font-size: .8em;
}

pre.ipynb {
  color: black;
  background: #f7f7f7;
  border: none;
  box-shadow: none;
  margin-bottom: 0;
  padding: 0;
  margin: 0px;
  font-size: 13px;
}

/* remove the prompt div from text cells */
div.text_cell .prompt {
    display: none;
}

/* remove horizontal padding from text cells, */
/* so it aligns with outer body text */
div.text_cell_render {
    padding: 0.5em 0em;
}

img.anim_icon{padding:0; border:0; vertical-align:middle; -webkit-box-shadow:none; -box-shadow:none}

div.collapseheader {
    width=100%;
    background-color:#d3d3d3;
    padding: 2px;
    cursor: pointer;
    font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;
}
</style>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        processEscapes: true,
        displayMath: [['$$','$$'], ["\\[","\\]"]]
    }
});
</script>
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>

<script type="text/javascript">
jQuery(document).ready(function($) {
    $("div.collapseheader").click(function () {
    $header = $(this).children("span").first();
    $codearea = $(this).children(".input_area");
    console.log($(this).children());
    $codearea.slideToggle(500, function () {
        $header.text(function () {
            return $codearea.is(":visible") ? "Collapse Code" : "Expand Code";
        });
    });
});
});
</script>




        <title>Interactive Data Visualization of Geospatial Data using D3.js, DC.js, Leaflet.js and Python // Adil Moujahid // Bridging Tech and Art</title>



    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.3.0/pure-min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.1.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="../../../../theme/css/bootstrap.min.css">
    <link rel="stylesheet" href="../../../../theme/css/pure.css">
    <link rel="stylesheet" href="../../../../theme/css/pygments.css">
    <link rel="stylesheet" href="../../../../theme/css/custom.css">


    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

    <script src="//load.sumome.com/" data-sumo-site-id="4ce3990f4d6fb482b4d97fa9208bd2242f7bb8c711ce30290794390dbe7ed180" async></script>

</head>

<body>
<div class="pure-g-r" id="layout">
    <div class="sidebar sidebar-article pure-u">
        <header class="header-article">
            <hgroup>
                <a href="../../../../author/adil-moujahid.html" title="See posts by Adil Moujahid">
                        <img class="avatar" alt="Adil Moujahid" src="http://www.gravatar.com/avatar/2ac2a00f5911cc8234778be41c835e13">
                </a>
                <h2 class="article-info">Adil Moujahid</h2>
                <small class="about-author"></small>

                <!-- ko-fi -->
                <div>
                    <a href='https://ko-fi.com/W7W4K1LZ' target='_blank'><img height='36' src='https://az743702.vo.msecnd.net/cdn/kofi4.png?v=0' style='border:0px;height:32px;' border='0' alt='Buy Me a Coffee at ko-fi.com' /></a>
                </div>
                <br>

                <div>
                <a href="https://twitter.com/AdilMouja" class="twitter-follow-button" data-show-count="false">
                    Follow @AdilMouja
                </a>
                <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
                </div>

                <h5>Published</h5>
                <p>Sat 13 August 2016</p>
                <a href="/">&larr;Home</a>
            </hgroup>
        </header>
    </div>
    <div class="pure-u">
        <div class="content">
            <section class="post">
                <header class="post-header">
                    <h1>Interactive Data Visualization of Geospatial Data using D3.js, DC.js, Leaflet.js and Python</h1>
                    <br>
                    <p class="post-meta">
                        // tags                             <a class="post-category" href="../../../../tag/python/">python</a>
                            <a class="post-category" href="../../../../tag/javascript/">javascript</a>
                            <a class="post-category" href="../../../../tag/data-visualization/">data visualization</a>
                            <a class="post-category" href="../../../../tag/d3js/">d3.js</a>
                            <a class="post-category" href="../../../../tag/dcjs/">dc.js</a>
                            <a class="post-category" href="../../../../tag/leafletjs/">leaflet.js</a>
                    </p>
                </header>
            </section>
            <br>
            <p>The goal of this tutorial is to introduce the steps for building an interactive visualization of geospatial data.</p>
<p>To do this, we will use a dataset from a Kaggle competition to build a data visualization that shows the distribution of mobile phone users in China. We will also create additional charts that show the usage patterns, the most popular phone brands, and users’ age segments and gender. We will be able to filter the data by the different attributes and see the results reflected in the map and all charts.</p>
<p>We will cover a wide range of technologies in this tutorial: Pandas for cleaning the data, Flask for building the server, Javascript libraries d3.js, dc.js and crossfilter.js for building the charts and Leaflet.js for building the map.</p>
<p>The source code for this tutorial can be found in this <a href="https://github.com/adilmoujahid/kaggle-talkingdata-visualization">github repository</a>.</p>
<p>Below is an animated gif of the interactive data visualization dashboard that we will be building in this tutorial.</p>
<div style="text-align:center">
<p><img alt="Alt Text" src="/images/data-viz-talkingdata.gif"></p>
</div>
<h1>1. The Case Study</h1>
<p>In this tutorial, we will use a dataset from a Kaggle competition called <a href="https://www.kaggle.com/c/talkingdata-mobile-user-demographics">"TalkingData Mobile User Demographics"</a>. This dataset is provided by TalkingData, China’s largest third-party mobile data platform. It contains app usage data, geolocation data and mobile device properties.The goal of the competition is to predict the gender and age segments of users based on the data provided.</p>
<p>Data visualization is an important first step in the data analysis workflow. It enables us to effectively discover patterns through graphical means, and to represent these findings in a meaningful and effective way.</p>
<p>The dataset that we will use contains various attributes that can be combined together to build interesting data visualizations. Geospatial data is particularly interesting, as it allows us to see how the user profiles and usage behavior changes based on the location.</p>
<p>In this tutorial, we will build a data visualization that combines a map that shows user locations together with various charts that summarises users’ information and usage behavior. We will make this visualisation interactive, so we can drill down into a particular user segment or location.</p>
<h1>2. System Architecture</h1>
<p>For our data visualization, we need a system architecture that handles the following:</p>
<ol>
<li>Cleaning and structuring data for visualization. We will use mainly Python’s Pandas library for this.</li>
<li>Serving static files (html, css and Javascript file) and data to the browser. We will use a Python lightweight server called Flask for this.</li>
<li>Building the charts and map. We will mainly use 3 Javascript libraries for this. DC.js, D3.js and Leaflet.js.</li>
</ol>
<h1>3. Data Preparation</h1>
<p>We start by downloading the dataset from the competition website. You need to create a Kaggle account and agree to the competition rules to download the data.</p>
<p>We will be using 3 csv files: gender_age_train.csv, events.csv, phone_brand_device_model.csv.</p>
<ul>
<li>gender_age_train.csv: This file contains the device id, gender and age of users.</li>
<li>events.csv: This file contains information about phone events triggered by the users. Each event has an id, a timestamp and location info (latitude and longitude).</li>
<li>phone_brand_device_model.csv: This file contains the brand and model for each device.</li>
</ul>
<p>We start by importing <code>pandas</code>.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</code></pre></div>

<p>Next, we read and merge the different datasets into a single Pandas DataFrame that we call <code>df</code>.</p>
<div class="highlight"><pre><span></span><code><span class="n">gen_age_tr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_path</span> <span class="o">+</span> <span class="s1">&#39;gender_age_train.csv&#39;</span><span class="p">)</span>
<span class="n">ev</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_path</span> <span class="o">+</span> <span class="s1">&#39;events.csv&#39;</span><span class="p">)</span>
<span class="n">ph_br_dev_model</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_path</span> <span class="o">+</span> <span class="s1">&#39;phone_brand_device_model.csv&#39;</span><span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">gen_age_tr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;device_id&#39;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ph_br_dev_model</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;device_id&#39;</span><span class="p">)</span>
</code></pre></div>

<p>Next we add the english phone brand to our DataFrame.</p>
<div class="highlight"><pre><span></span><code><span class="n">top_10_brands_en</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;华为&#39;</span><span class="p">:</span><span class="s1">&#39;Huawei&#39;</span><span class="p">,</span> <span class="s1">&#39;小米&#39;</span><span class="p">:</span><span class="s1">&#39;Xiaomi&#39;</span><span class="p">,</span> <span class="s1">&#39;三星&#39;</span><span class="p">:</span><span class="s1">&#39;Samsung&#39;</span><span class="p">,</span> <span class="s1">&#39;vivo&#39;</span><span class="p">:</span><span class="s1">&#39;vivo&#39;</span><span class="p">,</span> <span class="s1">&#39;OPPO&#39;</span><span class="p">:</span><span class="s1">&#39;OPPO&#39;</span><span class="p">,</span> 
                    <span class="s1">&#39;魅族&#39;</span><span class="p">:</span><span class="s1">&#39;Meizu&#39;</span><span class="p">,</span> <span class="s1">&#39;酷派&#39;</span><span class="p">:</span><span class="s1">&#39;Coolpad&#39;</span><span class="p">,</span> <span class="s1">&#39;乐视&#39;</span><span class="p">:</span><span class="s1">&#39;LeEco&#39;</span><span class="p">,</span> <span class="s1">&#39;联想&#39;</span><span class="p">:</span><span class="s1">&#39;Lenovo&#39;</span><span class="p">,</span> <span class="s1">&#39;HTC&#39;</span><span class="p">:</span><span class="s1">&#39;HTC&#39;</span><span class="p">}</span>

<span class="n">df</span><span class="p">[</span><span class="s1">&#39;phone_brand_en&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;phone_brand&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">phone_brand</span><span class="p">:</span> <span class="n">top_10_brands_en</span><span class="p">[</span><span class="n">phone_brand</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">phone_brand</span> <span class="ow">in</span> <span class="n">top_10_brands_en</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;Other&#39;</span><span class="p">)</span>
</code></pre></div>

<p>Next, we add the age segment of users to the DataFrame.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_age_segment</span><span class="p">(</span><span class="n">age</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">age</span> <span class="o">&lt;=</span> <span class="mi">22</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;22-&#39;</span>
    <span class="k">elif</span> <span class="n">age</span> <span class="o">&lt;=</span> <span class="mi">26</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;23-26&#39;</span>
    <span class="k">elif</span> <span class="n">age</span> <span class="o">&lt;=</span> <span class="mi">28</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;27-28&#39;</span>
    <span class="k">elif</span> <span class="n">age</span> <span class="o">&lt;=</span> <span class="mi">32</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;29-32&#39;</span>
    <span class="k">elif</span> <span class="n">age</span> <span class="o">&lt;=</span> <span class="mi">38</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;33-38&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;39+&#39;</span>

<span class="n">df</span><span class="p">[</span><span class="s1">&#39;age_segment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">age</span><span class="p">:</span> <span class="n">get_age_segment</span><span class="p">(</span><span class="n">age</span><span class="p">))</span>
</code></pre></div>

<p>Next, we add to each record the Chinese province where the event was recorded. To do this, we need 2 elements:</p>
<ul>
<li>China provinces' borders. I prepared this data and stored it in a json file called china_provinces_en.json.</li>
<li>A function that takes as input the longitude and latitude of the event and outputs the Chinese province where the event was recorded. The function is called <code>get_location</code>. This function uses a python library called <code>shapely</code>.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Point</span><span class="p">,</span> <span class="n">shape</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">data_path</span> <span class="o">+</span> <span class="s1">&#39;/geojson/china_provinces_en.json&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">data_file</span><span class="p">:</span>
    <span class="n">provinces_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_location</span><span class="p">(</span><span class="n">longitude</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">provinces_json</span><span class="p">):</span>
    <span class="n">point</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">longitude</span><span class="p">,</span> <span class="n">latitude</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">provinces_json</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">]:</span>
        <span class="n">polygon</span> <span class="o">=</span> <span class="n">shape</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">polygon</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">point</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="s1">&#39;other&#39;</span>

<span class="n">df</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">get_location</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">],</span> <span class="n">provinces_json</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>

<p>Next, we define the columns that we will need for the data visualization and we delete the records with missing values.</p>
<div class="highlight"><pre><span></span><code><span class="n">cols_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">,</span> <span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;phone_brand_en&#39;</span><span class="p">,</span> <span class="s1">&#39;gender&#39;</span><span class="p">,</span> <span class="s1">&#39;age_segment&#39;</span><span class="p">,</span> <span class="s1">&#39;location&#39;</span><span class="p">]</span>
<span class="n">df_clean</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">cols_to_keep</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
</code></pre></div>

<p>To communicate the data to the browser, we need to transform the format from a Pandas DataFrame to a JSON object. We can do that by simply calling to_json() function on our Pandas DataFrame.</p>
<div class="highlight"><pre><span></span><code><span class="n">df_clean</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;records&#39;</span><span class="p">)</span>
</code></pre></div>

<h1>4. Building the Server</h1>
<p>To build the server, we will use a Python library called Flask. The server's code is stored under <code>app.py</code>.</p>
<p>Our server will have 2 routes:</p>
<ul>
<li>The first route is used for serving the html file (that we will build in the next section).</li>
<li>The second route serves the data that we prepared in the previous section in json format.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Point</span><span class="p">,</span> <span class="n">shape</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s2">&quot;index.html&quot;</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/data&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_data</span><span class="p">():</span>
    <span class="c1"># Code from the previous section: Data preparation</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="k">return</span> <span class="n">df_clean</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s1">&#39;records&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>

<p>We can start the server, by executing the command below from the command line. </p>
<div class="highlight"><pre><span></span><code>python app.py
</code></pre></div>

<p>From your browser, go to <code>localhost:5000/data</code> and you will see the data printed in json format.</p>
<h1>5. Front-end Side Preparation</h1>
<p>Now that we have the data processing and server side code ready, we can start building the front-end code. </p>
<p>We will be using a great responsive dashboard template from <a href="http://keen.github.io/dashboards/">keen.io</a>. keen.io templates provide the skeleton for analytics dashboards. With these pre-built templates, we only need to focus on building the charts without spending much effort in customizing the layout. For this tutorial, I created a new layout based on keen.io Javascript and css libraries. </p>
<p>For building the charts, we will be mainly using 4 Javascript libraries Crossfilter.js, D3.js and DC.js.</p>
<ul>
<li><a href="http://square.github.io/crossfilter/">Crossfilter.js</a> is a Javascript library for grouping, filtering, and aggregating large datasets.</li>
<li><a href="https://d3js.org/">D3.js</a> is a Javascript library for controlling the data and building charts.</li>
<li><a href="https://dc-js.github.io/dc.js/">DC.js</a> is a Javascript charting library that leverages both crossfilter.js and d3.js, and makes the creation of highly interactive data visualization simple.</li>
<li><a href="http://leafletjs.com/">Leaflet.js</a> is JavaScript library for interactive maps. Leaflet has many plugins that can be used to extend its functionalities. We will use the <a href="https://github.com/Leaflet/Leaflet.heat">heatmap plugin</a> to show the distribution of users in the map.</li>
</ul>
<p>In addition to the Javascript libraries above, we will use <a href="https://github.com/d3/d3-queue">queue.js</a> which is an asynchronous helper library for Javascript, and <a href="http://underscorejs.org/">underscore.js</a> which is Javascript library that contains useful functional programming helpers.</p>
<p>Below is the folder structure of our project.</p>
<div style="text-align:center">
<p><img alt="Alt Text" src="/images/talkingdata-folder-structure.png"></p>
</div>
<p>Note that the only files that we need to create from scratch are:</p>
<ul>
<li>app.py: Server side code for rendering html pages and serving data to the browser</li>
<li>charts.js: Javascript file that will contain the code of our charts and map</li>
<li>custom.css: css file that will contain our custom css code</li>
</ul>
<p>We also need to make a few modifications to the index.html. Inside index.html, we need to reference the charts from charts.js.</p>
<h1>6. Building the Charts and Map</h1>
<p>The source code for the charts and map goes into <code>graphs.js</code>.</p>
<p>We start by using a <code>queue()</code> function from the queue.js library for reading the data from the server and executing the function <code>makegraphs()</code>. The <code>queue()</code> function makes sure that we have all the data transferred to the browser before drawing the graphs. </p>
<p>The <code>makeGraphs()</code> function contains the code for cleaning the data, building the crossfilter dimensions for filtering the data, the dc.js charts and the map. It takes 2 arguments, the first one is <code>error</code> which can be used for handling any error from the the <code>.defer</code> function, and as second argument <code>recordsJson</code> which contain the data that we read from the server.</p>
<div class="highlight"><pre><span></span><code><span class="nx">queue</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="nx">defer</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">json</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;/data&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="k">await</span><span class="p">(</span><span class="nx">makeGraphs</span><span class="p">);</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">makeGraphs</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span><span class="w"> </span><span class="nx">recordsJson</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="p">.</span>
<span class="p">.</span>
<span class="p">.</span>
<span class="p">};</span>
</code></pre></div>

<p>Inside the makeGraphs function, we start by cleaning the projects data. We change the date type from string to datetime objects, and we set all timestamps' minutes and seconds to 0. We also make sure that the longitute and latitude types are numeric.</p>
<div class="highlight"><pre><span></span><code><span class="kd">var</span><span class="w"> </span><span class="nx">records</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">recordsJson</span><span class="p">;</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">dateFormat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="s2">&quot;%Y-%m-%d %H:%M:%S&quot;</span><span class="p">);</span>

<span class="nx">records</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">d</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">dateFormat</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]);</span>
<span class="w">    </span><span class="nx">d</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">].</span><span class="nx">setMinutes</span><span class="p">(</span><span class="mf">0</span><span class="p">);</span>
<span class="w">    </span><span class="nx">d</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">].</span><span class="nx">setSeconds</span><span class="p">(</span><span class="mf">0</span><span class="p">);</span>
<span class="w">    </span><span class="nx">d</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">+</span><span class="nx">d</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">];</span>
<span class="w">    </span><span class="nx">d</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">+</span><span class="nx">d</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">];</span>
<span class="p">});</span>
</code></pre></div>

<p>Next, we create a <code>crossfilter</code> instance.</p>
<div class="highlight"><pre><span></span><code><span class="kd">var</span><span class="w"> </span><span class="nx">ndx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">crossfilter</span><span class="p">(</span><span class="nx">records</span><span class="p">);</span>
</code></pre></div>

<p>Next, we define data dimensions.</p>
<div class="highlight"><pre><span></span><code><span class="kd">var</span><span class="w"> </span><span class="nx">dateDim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ndx</span><span class="p">.</span><span class="nx">dimension</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">d</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">];</span><span class="w"> </span><span class="p">});</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">genderDim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ndx</span><span class="p">.</span><span class="nx">dimension</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">d</span><span class="p">[</span><span class="s2">&quot;gender&quot;</span><span class="p">];</span><span class="w"> </span><span class="p">});</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">ageSegmentDim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ndx</span><span class="p">.</span><span class="nx">dimension</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">d</span><span class="p">[</span><span class="s2">&quot;age_segment&quot;</span><span class="p">];</span><span class="w"> </span><span class="p">});</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">phoneBrandDim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ndx</span><span class="p">.</span><span class="nx">dimension</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">d</span><span class="p">[</span><span class="s2">&quot;phone_brand_en&quot;</span><span class="p">];</span><span class="w"> </span><span class="p">});</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">locationdDim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ndx</span><span class="p">.</span><span class="nx">dimension</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">d</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">];</span><span class="w"> </span><span class="p">});</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">allDim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ndx</span><span class="p">.</span><span class="nx">dimension</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="k">return</span><span class="w"> </span><span class="nx">d</span><span class="p">;});</span>
</code></pre></div>

<p>Next, we define data groups.</p>
<div class="highlight"><pre><span></span><code><span class="kd">var</span><span class="w"> </span><span class="nx">numRecordsByDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">dateDim</span><span class="p">.</span><span class="nx">group</span><span class="p">();</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">genderGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">genderDim</span><span class="p">.</span><span class="nx">group</span><span class="p">();</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">ageSegmentGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ageSegmentDim</span><span class="p">.</span><span class="nx">group</span><span class="p">();</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">phoneBrandGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">phoneBrandDim</span><span class="p">.</span><span class="nx">group</span><span class="p">();</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">locationGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">locationdDim</span><span class="p">.</span><span class="nx">group</span><span class="p">();</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">all</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">ndx</span><span class="p">.</span><span class="nx">groupAll</span><span class="p">();</span>
</code></pre></div>

<p>Next, we define the first and last timestamps. </p>
<div class="highlight"><pre><span></span><code><span class="kd">var</span><span class="w"> </span><span class="nx">minDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">dateDim</span><span class="p">.</span><span class="nx">bottom</span><span class="p">(</span><span class="mf">1</span><span class="p">)[</span><span class="mf">0</span><span class="p">][</span><span class="s2">&quot;timestamp&quot;</span><span class="p">];</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">maxDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">dateDim</span><span class="p">.</span><span class="nx">top</span><span class="p">(</span><span class="mf">1</span><span class="p">)[</span><span class="mf">0</span><span class="p">][</span><span class="s2">&quot;timestamp&quot;</span><span class="p">];</span>
</code></pre></div>

<p>Next we define the DC.js charts. The first one is a number that will show the total number of events. The second one is a bar chart that will show the number of events by time. The remaining ones are row charts that will show the data broken down by gender, age segments, phone brands and Chinese provinces.</p>
<div class="highlight"><pre><span></span><code><span class="kd">var</span><span class="w"> </span><span class="nx">numberRecordsND</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">dc</span><span class="p">.</span><span class="nx">numberDisplay</span><span class="p">(</span><span class="s2">&quot;#number-records-nd&quot;</span><span class="p">);</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">timeChart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">dc</span><span class="p">.</span><span class="nx">barChart</span><span class="p">(</span><span class="s2">&quot;#time-chart&quot;</span><span class="p">);</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">genderChart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">dc</span><span class="p">.</span><span class="nx">rowChart</span><span class="p">(</span><span class="s2">&quot;#gender-row-chart&quot;</span><span class="p">);</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">ageSegmentChart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">dc</span><span class="p">.</span><span class="nx">rowChart</span><span class="p">(</span><span class="s2">&quot;#age-segment-row-chart&quot;</span><span class="p">);</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">phoneBrandChart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">dc</span><span class="p">.</span><span class="nx">rowChart</span><span class="p">(</span><span class="s2">&quot;#phone-brand-row-chart&quot;</span><span class="p">);</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">locationChart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">dc</span><span class="p">.</span><span class="nx">rowChart</span><span class="p">(</span><span class="s2">&quot;#location-row-chart&quot;</span><span class="p">);</span>
</code></pre></div>

<p>For each DC.js chart, we pass the necessary parameters.</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nx">numberRecordsND</span>
<span class="w">    </span><span class="p">.</span><span class="nx">formatNumber</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">))</span>
<span class="w">    </span><span class="p">.</span><span class="nx">valueAccessor</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">){</span><span class="k">return</span><span class="w"> </span><span class="nx">d</span><span class="p">;</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">.</span><span class="nx">group</span><span class="p">(</span><span class="nx">all</span><span class="p">);</span>


<span class="w">  </span><span class="nx">timeChart</span>
<span class="w">    </span><span class="p">.</span><span class="nx">width</span><span class="p">(</span><span class="mf">650</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">height</span><span class="p">(</span><span class="mf">140</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">margins</span><span class="p">({</span><span class="nx">top</span><span class="o">:</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span><span class="w"> </span><span class="nx">right</span><span class="o">:</span><span class="w"> </span><span class="mf">50</span><span class="p">,</span><span class="w"> </span><span class="nx">bottom</span><span class="o">:</span><span class="w"> </span><span class="mf">20</span><span class="p">,</span><span class="w"> </span><span class="nx">left</span><span class="o">:</span><span class="w"> </span><span class="mf">20</span><span class="p">})</span>
<span class="w">    </span><span class="p">.</span><span class="nx">dimension</span><span class="p">(</span><span class="nx">dateDim</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">group</span><span class="p">(</span><span class="nx">numRecordsByDate</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">transitionDuration</span><span class="p">(</span><span class="mf">500</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">scale</span><span class="p">().</span><span class="nx">domain</span><span class="p">([</span><span class="nx">minDate</span><span class="p">,</span><span class="w"> </span><span class="nx">maxDate</span><span class="p">]))</span>
<span class="w">    </span><span class="p">.</span><span class="nx">elasticY</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">yAxis</span><span class="p">().</span><span class="nx">ticks</span><span class="p">(</span><span class="mf">4</span><span class="p">);</span>

<span class="w">  </span><span class="nx">genderChart</span>
<span class="w">        </span><span class="p">.</span><span class="nx">width</span><span class="p">(</span><span class="mf">300</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">height</span><span class="p">(</span><span class="mf">100</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">dimension</span><span class="p">(</span><span class="nx">genderDim</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">group</span><span class="p">(</span><span class="nx">genderGroup</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">ordering</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="nx">d</span><span class="p">.</span><span class="nx">value</span><span class="w"> </span><span class="p">})</span>
<span class="w">        </span><span class="p">.</span><span class="nx">colors</span><span class="p">([</span><span class="s1">&#39;#6baed6&#39;</span><span class="p">])</span>
<span class="w">        </span><span class="p">.</span><span class="nx">elasticX</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">xAxis</span><span class="p">().</span><span class="nx">ticks</span><span class="p">(</span><span class="mf">4</span><span class="p">);</span>

<span class="w">  </span><span class="nx">ageSegmentChart</span>
<span class="w">    </span><span class="p">.</span><span class="nx">width</span><span class="p">(</span><span class="mf">300</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">height</span><span class="p">(</span><span class="mf">150</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">dimension</span><span class="p">(</span><span class="nx">ageSegmentDim</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">group</span><span class="p">(</span><span class="nx">ageSegmentGroup</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">colors</span><span class="p">([</span><span class="s1">&#39;#6baed6&#39;</span><span class="p">])</span>
<span class="w">        </span><span class="p">.</span><span class="nx">elasticX</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">labelOffsetY</span><span class="p">(</span><span class="mf">10</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">xAxis</span><span class="p">().</span><span class="nx">ticks</span><span class="p">(</span><span class="mf">4</span><span class="p">);</span>

<span class="w">  </span><span class="nx">phoneBrandChart</span>
<span class="w">    </span><span class="p">.</span><span class="nx">width</span><span class="p">(</span><span class="mf">300</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">height</span><span class="p">(</span><span class="mf">310</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">dimension</span><span class="p">(</span><span class="nx">phoneBrandDim</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">group</span><span class="p">(</span><span class="nx">phoneBrandGroup</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">ordering</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="nx">d</span><span class="p">.</span><span class="nx">value</span><span class="w"> </span><span class="p">})</span>
<span class="w">        </span><span class="p">.</span><span class="nx">colors</span><span class="p">([</span><span class="s1">&#39;#6baed6&#39;</span><span class="p">])</span>
<span class="w">        </span><span class="p">.</span><span class="nx">elasticX</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">xAxis</span><span class="p">().</span><span class="nx">ticks</span><span class="p">(</span><span class="mf">4</span><span class="p">);</span>

<span class="w">    </span><span class="nx">locationChart</span>
<span class="w">      </span><span class="p">.</span><span class="nx">width</span><span class="p">(</span><span class="mf">200</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">height</span><span class="p">(</span><span class="mf">510</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">dimension</span><span class="p">(</span><span class="nx">locationdDim</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">group</span><span class="p">(</span><span class="nx">locationGroup</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">ordering</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="nx">d</span><span class="p">.</span><span class="nx">value</span><span class="w"> </span><span class="p">})</span>
<span class="w">        </span><span class="p">.</span><span class="nx">colors</span><span class="p">([</span><span class="s1">&#39;#6baed6&#39;</span><span class="p">])</span>
<span class="w">        </span><span class="p">.</span><span class="nx">elasticX</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">labelOffsetY</span><span class="p">(</span><span class="mf">10</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">xAxis</span><span class="p">().</span><span class="nx">ticks</span><span class="p">(</span><span class="mf">4</span><span class="p">);</span>
</code></pre></div>

<p>Next, we initialize a leaflet map.</p>
<div class="highlight"><pre><span></span><code><span class="kd">var</span><span class="w"> </span><span class="nx">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">L</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="s1">&#39;map&#39;</span><span class="p">);</span>
</code></pre></div>

<p>We define a function that will draw the map and adds a layer of heatmap representing the geographical distribution of events.</p>
<div class="highlight"><pre><span></span><code><span class="kd">var</span><span class="w"> </span><span class="nx">drawMap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(){</span>

<span class="w">    </span><span class="nx">map</span><span class="p">.</span><span class="nx">setView</span><span class="p">([</span><span class="mf">31.75</span><span class="p">,</span><span class="w"> </span><span class="mf">110</span><span class="p">],</span><span class="w"> </span><span class="mf">4</span><span class="p">);</span>
<span class="w">    </span><span class="nx">mapLink</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&lt;a href=&quot;http://openstreetmap.org&quot;&gt;OpenStreetMap&lt;/a&gt;&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="nx">L</span><span class="p">.</span><span class="nx">tileLayer</span><span class="p">(</span>
<span class="w">        </span><span class="s1">&#39;http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">attribution</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&amp;copy; &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">mapLink</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; Contributors&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">maxZoom</span><span class="o">:</span><span class="w"> </span><span class="mf">15</span><span class="p">,</span>
<span class="w">        </span><span class="p">}).</span><span class="nx">addTo</span><span class="p">(</span><span class="nx">map</span><span class="p">);</span>

<span class="w">    </span><span class="c1">//HeatMap</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">geoData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="w">    </span><span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">allDim</span><span class="p">.</span><span class="nx">top</span><span class="p">(</span><span class="kc">Infinity</span><span class="p">),</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">geoData</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">d</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">],</span><span class="w"> </span><span class="nx">d</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">],</span><span class="w"> </span><span class="mf">1</span><span class="p">]);</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">heat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">L</span><span class="p">.</span><span class="nx">heatLayer</span><span class="p">(</span><span class="nx">geoData</span><span class="p">,{</span>
<span class="w">        </span><span class="nx">radius</span><span class="o">:</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span>
<span class="w">        </span><span class="nx">blur</span><span class="o">:</span><span class="w"> </span><span class="mf">20</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="nx">maxZoom</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">    </span><span class="p">}).</span><span class="nx">addTo</span><span class="p">(</span><span class="nx">map</span><span class="p">);</span>

<span class="p">};</span>
</code></pre></div>

<p>We call <code>drawMap()</code> function to display the map.</p>
<div class="highlight"><pre><span></span><code><span class="nx">drawMap</span><span class="p">();</span>
</code></pre></div>

<p>Next we define the rules for updating the map. The code below makes sure that anytime we filter any DC.js charts, we redraw the map with the new filtered data.</p>
<div class="highlight"><pre><span></span><code><span class="nx">dcCharts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nx">timeChart</span><span class="p">,</span><span class="w"> </span><span class="nx">genderChart</span><span class="p">,</span><span class="w"> </span><span class="nx">ageSegmentChart</span><span class="p">,</span><span class="w"> </span><span class="nx">phoneBrandChart</span><span class="p">,</span><span class="w"> </span><span class="nx">locationChart</span><span class="p">];</span>

<span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">dcCharts</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">dcChart</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">dcChart</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;filtered&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">chart</span><span class="p">,</span><span class="w"> </span><span class="nx">filter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">map</span><span class="p">.</span><span class="nx">eachLayer</span><span class="p">(</span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">layer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">map</span><span class="p">.</span><span class="nx">removeLayer</span><span class="p">(</span><span class="nx">layer</span><span class="p">)</span>
<span class="w">        </span><span class="p">});</span><span class="w"> </span>
<span class="w">    </span><span class="nx">drawMap</span><span class="p">();</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">});</span>
</code></pre></div>

<p>And finally, we call the <code>dc.renderAll()</code> function for rendering all the charts.</p>
<div class="highlight"><pre><span></span><code><span class="nx">dc</span><span class="p">.</span><span class="nx">renderAll</span><span class="p">();</span>
</code></pre></div>

<p>Inside the <code>index.html</code> file, we have to reference all the charts that we defined in the charts.js file. For example, if we want to show the timeline chart, we have to add the line below to the index.html file.</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;time-chart&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</code></pre></div>

<h1>Conclusion</h1>
<p>In this tutorial, we learned how to build an interactive data visualization of geospatial data by combining DC.js charts with Leaflet.js. If you liked this tutorial, we might want to check a <a href="http://adilmoujahid.com/posts/2015/01/interactive-data-visualization-d3-dc-python-mongodb/">similar one</a> where I used MongoDB as a data source instead of csv files.</p>
            <div class="hr"></div>
            
            <!-- Begin MailChimp Signup Form -->
            <link href="//cdn-images.mailchimp.com/embedcode/slim-081711.css" rel="stylesheet" type="text/css">
            <style type="text/css">
                #mc_embed_signup{background:#F1F3F3; clear:left; font:14px Helvetica,Arial,sans-serif; }
                #mc-embedded-subscribe.button{background-color: #0f52ba;}
                /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
                   We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
            </style>
            <div id="mc_embed_signup">
            <form action="//adilmoujahid.us10.list-manage.com/subscribe/post?u=28846a375fbf5c13a93712283&amp;id=a45c6ff723" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
                <div id="mc_embed_signup_scroll">
                <label for="mce-EMAIL">Subscribe to my Data in Practice Newsletter</label>
                <input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
                <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
                <div style="position: absolute; left: -5000px;"><input type="text" name="b_28846a375fbf5c13a93712283_a45c6ff723" tabindex="-1" value=""></div>
                <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
                </div>
            </form>
            </div>

            <!--End mc_embed_signup-->
            <a href="#" class="go-top">Go Top</a>
<div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = "adilmoujahid"; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div><footer class="footer">
    <p>&copy; Adil Moujahid &ndash;
        Built with <a href="https://github.com/PurePelicanTheme/pure">Pure Theme</a>
        for <a href="http://blog.getpelican.com/">Pelican</a>
    </p>
</footer>        </div>
    </div>
</div>
    <script>
        var $top = $('.go-top');

        // Show or hide the sticky footer button
        $(window).scroll(function() {
            if ($(this).scrollTop() > 200) {
                $top.fadeIn(200);
            } else {
                $top.fadeOut(200);
            }
        });

        // Animate the scroll to top
        $top.click(function(event) {
            event.preventDefault();
            $('html, body').animate({scrollTop: 0}, 300);
        })

        // Makes sure that the href="#" attached to the <a> elements
        // don't scroll you back up the page.
        $('body').on('click', 'a[href="#"]', function(event) {
            event.preventDefault();
        });

        //Added on 2023-04-12 to fix the CSS of jupyter notebook (padding issue)
        document.addEventListener("DOMContentLoaded", function () {
            const inputPrompt = document.querySelector('.jp-InputPrompt.jp-InputArea-prompt');
            
            if (inputPrompt.textContent.trim() === '') {
                inputPrompt.classList.add('empty');
            } else {
                inputPrompt.classList.remove('empty');
            }
        });


    </script>
    <script type="text/javascript">
        var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
        document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
        try {
            var pageTracker = _gat._getTracker("UA-52651211-1");
            pageTracker._trackPageview();
            } catch(err) {}
    </script>
</body>


</html>